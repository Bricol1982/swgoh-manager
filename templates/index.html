{% extends "base.html" %}

{% block title %}Dashboard - SWGOH Manager{% endblock %}

{% block content %}
<div class="dashboard-header" style="text-align: center; margin-bottom: 2rem;">
    <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem; color: #ffd700;">
        🎮 SWGOH Manager Dashboard
    </h1>
    <p style="color: #b0b0b0; font-size: 1.1rem;">
        Gérez et optimisez votre roster Star Wars: Galaxy of Heroes
    </p>
</div>

<!-- Ally Code Input Section -->
<div class="card">
    <h2 class="card-header">📋 Chargement du Roster</h2>
    <div class="form-group">
        <label for="allyCode">Ally Code :</label>
        <input 
            type="text" 
            id="allyCode" 
            class="form-control"
            placeholder="123-456-789" 
            pattern="\d{3}-\d{3}-\d{3}"
            maxlength="11"
        >
    </div>
    <button id="loadDataBtn" class="btn">
        📥 Récupérer les données
    </button>
    <div id="loadingStatus" style="display: none; margin-top: 1rem;">
        <span class="loading"></span> Chargement en cours...
    </div>
</div>

<!-- Player Info Section -->
<div id="playerInfoSection" style="display: none;">
    <div class="card">
        <h2 class="card-header">👤 Informations Joueur</h2>
        <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
            <div>
                <div style="color: #b0b0b0; margin-bottom: 0.25rem;">Nom</div>
                <div id="playerName" style="color: #ffd700; font-size: 1.2rem; font-weight: 600;">-</div>
            </div>
            <div>
                <div style="color: #b0b0b0; margin-bottom: 0.25rem;">Niveau</div>
                <div id="playerLevel" style="color: #ffd700; font-size: 1.2rem; font-weight: 600;">-</div>
            </div>
            <div>
                <div style="color: #b0b0b0; margin-bottom: 0.25rem;">Guilde</div>
                <div id="guildName" style="color: #ffd700; font-size: 1.2rem; font-weight: 600;">-</div>
            </div>
            <div>
                <div style="color: #b0b0b0; margin-bottom: 0.25rem;">Dernière mise à jour</div>
                <div id="lastUpdate" style="color: #ffd700; font-size: 1.2rem; font-weight: 600;">-</div>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="grid">
        <div class="stat-card">
            <div style="font-size: 2.5rem;">⚡</div>
            <div class="stat-label">Galactic Power</div>
            <div class="stat-value" id="totalGP">0</div>
        </div>
        <div class="stat-card">
            <div style="font-size: 2.5rem;">👥</div>
            <div class="stat-label">Personnages</div>
            <div class="stat-value" id="totalCharacters">0</div>
        </div>
        <div class="stat-card">
            <div style="font-size: 2.5rem;">🎖️</div>
            <div class="stat-label">Reliques R5+</div>
            <div class="stat-value" id="totalRelics">0</div>
        </div>
        <div class="stat-card">
            <div style="font-size: 2.5rem;">🔷</div>
            <div class="stat-label">Mods</div>
            <div class="stat-value" id="totalMods">0</div>
        </div>
    </div>

    <!-- Top Characters -->
    <div class="card">
        <h2 class="card-header">🏆 Top 10 Personnages (GP)</h2>
        <div class="table-container">
            <table id="topCharactersTable">
                <thead>
                    <tr>
                        <th>Rang</th>
                        <th>Personnage</th>
                        <th style="text-align: right;">Galactic Power</th>
                    </tr>
                </thead>
                <tbody id="topCharacters">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card">
        <h2 class="card-header">⚡ Actions Rapides</h2>
        <div class="grid">
            <a href="/mods" style="text-decoration: none;">
                <div class="stat-card" style="cursor: pointer; transition: transform 0.3s;" 
                     onmouseover="this.style.transform='translateY(-4px)'" 
                     onmouseout="this.style.transform='translateY(0)'">
                    <div style="font-size: 3rem;">🔷</div>
                    <h3 style="color: #ffd700; margin: 0.5rem 0;">Gérer les Mods</h3>
                    <p style="color: #b0b0b0; font-size: 0.9rem; margin: 0;">
                        Visualiser et filtrer vos mods
                    </p>
                </div>
            </a>
            <a href="/optimizer" style="text-decoration: none;">
                <div class="stat-card" style="cursor: pointer; transition: transform 0.3s;" 
                     onmouseover="this.style.transform='translateY(-4px)'" 
                     onmouseout="this.style.transform='translateY(0)'">
                    <div style="font-size: 3rem;">🚀</div>
                    <h3 style="color: #ffd700; margin: 0.5rem 0;">Optimiser</h3>
                    <p style="color: #b0b0b0; font-size: 0.9rem; margin: 0;">
                        Optimiser les mods de vos personnages
                    </p>
                </div>
            </a>
            <a href="/loadouts" style="text-decoration: none;">
                <div class="stat-card" style="cursor: pointer; transition: transform 0.3s;" 
                     onmouseover="this.style.transform='translateY(-4px)'" 
                     onmouseout="this.style.transform='translateY(0)'">
                    <div style="font-size: 3rem;">📋</div>
                    <h3 style="color: #ffd700; margin: 0.5rem 0;">Loadouts</h3>
                    <p style="color: #b0b0b0; font-size: 0.9rem; margin: 0;">
                        Gérer vos compositions d'équipes
                    </p>
                </div>
            </a>
            <a href="/gac" style="text-decoration: none;">
                <div class="stat-card" style="cursor: pointer; transition: transform 0.3s;" 
                     onmouseover="this.style.transform='translateY(-4px)'" 
                     onmouseout="this.style.transform='translateY(0)'">
                    <div style="font-size: 3rem;">⚔️</div>
                    <h3 style="color: #ffd700; margin: 0.5rem 0;">GAC Compare</h3>
                    <p style="color: #b0b0b0; font-size: 0.9rem; margin: 0;">
                        Comparer avec un adversaire
                    </p>
                </div>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const allyCodeInput = document.getElementById('allyCode');
    const loadDataBtn = document.getElementById('loadDataBtn');
    const loadingStatus = document.getElementById('loadingStatus');
    const playerInfoSection = document.getElementById('playerInfoSection');

    // Charge l'ally code stocké
    const storedAllyCode = getStoredAllyCode();
    if (storedAllyCode) {
        allyCodeInput.value = formatAllyCode(storedAllyCode);
    }

    // Format ally code input
    allyCodeInput.addEventListener('input', function(e) {
        let value = e.target.value.replace(/[^\d]/g, '');
        e.target.value = formatAllyCode(value);
    });

    // Load data button
    loadDataBtn.addEventListener('click', async function() {
        const allyCode = allyCodeInput.value.replace(/-/g, '');
        
        if (allyCode.length !== 9) {
            showAlert('Veuillez entrer un Ally Code valide (9 chiffres)', 'error');
            return;
        }

        const hideLoading = showLoading(loadDataBtn);
        loadingStatus.style.display = 'block';

        try {
            const response = await fetch('/api/load_player_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ally_code: allyCode })
            });

            const data = await response.json();

            if (response.ok) {
                saveAllyCode(allyCode);
                showAlert('Données chargées avec succès !', 'success');
                displayPlayerData(data);
            } else {
                showAlert(data.error || 'Erreur lors du chargement des données', 'error');
            }
        } catch (error) {
            showAlert('Erreur de connexion au serveur', 'error');
            console.error('Error:', error);
        } finally {
            loadingStatus.style.display = 'none';
            hideLoading();
        }
    });

    function displayPlayerData(data) {
        // Player info
        document.getElementById('playerName').textContent = data.player.name || '-';
        document.getElementById('playerLevel').textContent = data.player.level || '-';
        document.getElementById('guildName').textContent = data.player.guild_name || 'Aucune';
        document.getElementById('lastUpdate').textContent = new Date().toLocaleString('fr-FR');

        // Stats
        document.getElementById('totalGP').textContent = formatNumber(data.stats.total_gp);
        document.getElementById('totalCharacters').textContent = data.stats.total_characters;
        document.getElementById('totalRelics').textContent = data.stats.relics_r5_plus;
        document.getElementById('totalMods').textContent = data.stats.total_mods;

        // Top characters
        const topCharactersBody = document.getElementById('topCharacters');
        topCharactersBody.innerHTML = '';
        
        data.top_characters.forEach((char, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="font-weight: 600; color: #ffd700;">#${index + 1}</td>
                <td>${char.name}</td>
                <td style="text-align: right; color: #667eea; font-weight: 600;">
                    ${formatNumber(char.gp)} GP
                </td>
            `;
            topCharactersBody.appendChild(row);
        });

        // Show player info section
        playerInfoSection.style.display = 'block';
        
        // Scroll to results
        playerInfoSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function formatAllyCode(value) {
        if (value.length > 3 && value.length <= 6) {
            return value.slice(0, 3) + '-' + value.slice(3);
        } else if (value.length > 6) {
            return value.slice(0, 3) + '-' + value.slice(3, 6) + '-' + value.slice(6, 9);
        }
        return value;
    }

    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }

    // Check if there's already loaded data
    fetch('/api/check_loaded_data')
        .then(response => response.json())
        .then(data => {
            if (data.has_data) {
                displayPlayerData(data);
            }
        })
        .catch(error => console.log('No previous data loaded'));
});
</script>
{% endblock %}